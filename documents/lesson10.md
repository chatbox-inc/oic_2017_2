# 10. 課題発表 クラスを利用したリファクタリング

リファクタリングとは、既存のコードに対して動きをそのままに保ちながら、コードをより読みやすくする、見やすくするための変更を行うことを言います。

長期的に「読める」コードを作成、管理するためにはリファクタリングのプロセスが必須で、綺麗なコードを書くための継続的な練習にもなります。

## ルートのリファクタリング

それなりの規模のアプリケーションを作成すると、`route/web.php` のファイル行数が大変なことになってきます。

だいたいひとつのファイルで管理できるコードの行数はせいぜい500行程度だと思います。

大規模なシステムでルートが数百にも及ぶ場合、`route/web.php`だけでルートを記述するには限界があります。

ルートをリファクタリングする場合には一般にコントローラクラスが使われます。

コントローラは `app/Http/Controllers` フォルダに作成します。

ファイル名は `{コントローラ名}.php` で内部で作成するクラス名と一致させる必要があります。 下の例では `ItemController.php` になります。

````
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;

class ItemController extends Controller
{
    public function detail($id)
    {
        ....
        return view('detail', [
            'item' => $item
        ]);
    }
}
````

PHP のクラス構文に関しては、教科書またはインターネット上のドキュメントを　参考にしてください(後者の方をおすすめします)。

他の言語同様 プロパティやメソドの実装が可能で、ルートの中で `function(){...}` を使用して記述していたルートの処理は、それぞれメソドで記述していく形となります。

ルートの側では以下のように記述します。

````
Route::get('detail/{id}', 'ItemController@detail');
````

ルートでは`function(){...}` と記述していた代わりに、`コントローラ名@メソド名` の形式で外部ファイルに記述した処理を参照する形を取ります。

コレで、複数行あったルートの記述が一行で済むようになり、また複数のルートを個別のファイルに分割することも可能になりました。

## 処理のリファクタリング

ルートの記述がリファクタリング出来たとしても、ルートの処理が長くなっている場合、これもまた読みにくいコードになってしまいます。

PHPではカスタムのクラスを利用して、コードを分割する事ができるようになっていますので、コレを利用して例えばセッションの処理などをクラスに分割してみましょう。

````
namespace App\Service;

class CartSession(){

    /** カートに商品を追加する */
    public function addItem($item){
        $items = request()->session()->get("CART",[]);
        $items[] = $item;
        request()->session()->put("CART",$items);
    }
    
    ....
}
````

上記のようなクラスは `app/Service` フォルダを作成して、`app/Service/CartSession.php` に作成していきます。

多くのPHPフレームワークシステムでは、 namespace と クラス名を フォルダ階層と紐付けてファイルを自動的に読み込む仕組みが採用されています。
自分でクラスを作成する際には、namespace と クラス名が フォルダ階層と一致する形で作成するようにしましょう。

コレをルートの　中で呼び出して利用するためには、以下のような記述を行います。

````
    $cartSession = new \App\Service\CartSession();
    $cartSession->addItem($item);
````

public で定義したメソドは外部から利用可能です。

適宜ファイルを分割して処理を外部化し、再利用可能な状態で複数のルートに提供する事で、処理の共通化やユニットテストも実施可能になり、システム全体の品質も向上します。

## よりシンプルなリファクタリング

上記のようなクラスを利用したリファクタリングの他にももっと簡単に実施可能なリファクタリングがあります。

インデントルールや改行ルールと言った、いわゆる「コード規約」を遵守することは、読みやすく、誰が見てもわかりやすいコードの実現に繋がります。

PHP の界隈では、PSR-0/1/2と呼ばれるコード規約が標準的に利用されています。

PSR-0 http://www.infiniteloop.co.jp/docs/psr/psr-0.html
PSR-1 http://www.infiniteloop.co.jp/docs/psr/psr-1-basic-coding-standard.html
PSR-2 http://www.infiniteloop.co.jp/docs/psr/psr-2-coding-style-guide.html

上記のような資料を参考に、正しいコードの書き方をマスターするのが良いでしょう。

## 本日の出席課題

課題発表申込書に内容を加筆して制作の状況を報告。

